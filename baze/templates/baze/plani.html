{% extends 'main.html' %}

{% block content %}

<div class="container mt-4">
    {% if ind_progresa_dati %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="">Mans mēneša progress</h4>
                        <span class="badge bg-light text-dark" style="font-size: 1.1rem;">Dienas līdz mēneša beigām: {{ palikusas_dienas }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Kategorija</th>
                                    <th class="text-center">Izpilde</th>
                                    <th class="text-center">Plāns</th>
                                    <th class="text-center">Progress (%)</th>
                                    <th class="text-center">Dienas individuālais mērķis</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in ind_progresa_dati %}
                                <tr>
                                    <td><strong>{{ row.kategorija }}</strong></td>
                                    <td class="text-center">{{ row.izpilde }}</td>
                                    <td class="text-center">{{ row.plans }}</td>
                                    <td class="text-center">
                                        <span class="badge {% if row.progress >= 50 %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ row.progress }}%
                                        </span>
                                    </td>
                                    <td class="text-center">{{ row.dienas_merkis }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">Līgumu proporcijas</h4>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Kategorija</th>
                                    <th class="text-center">Attiecība</th>
                                    <th class="text-center">Procentuāli</th>
                                    <th class="text-center">Plāns</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Atvērtā līguma proporcija</strong></td>
                                    <td class="text-center">{{ proporcijas.atv_iekartas|default:"0" }} / {{ proporcijas.atv_iekartas|default:"0"|add:proporcijas.nom_iekarta|default:"0" }}</td>
                                    <td class="text-center">{{ proporcijas.atv_proporcija|default:"0" }}%</td>
                                    <td class="text-center">{{ proporcijas.atv_plans|default:"0" }}%</td>
                                </tr>
                                <tr>
                                    <td><strong>Apdrošināšanas proporcija</strong></td>
                                    <td class="text-center">{{ proporcijas.apdr_iekartas|default:"0" }} / {{ proporcijas.iekartas|default:"0"|add:proporcijas.viedpaligi|default:"0" }}</td>
                                    <td class="text-center">{{ proporcijas.apdr_proporcija|default:"0" }}%</td>
                                    <td class="text-center">{{ proporcijas.apdr_plans|default:"0" }}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if perms.baze.add_plans %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Veikala plāni</h4>
                        <a href="{% url 'add-plans' %}" class="btn btn-light btn-sm">+ Pievienot plānu</a>
                    </div>
                </div>
                <div class="card-body">
                    {% if plani %}
                    <div class="list-group">
                        {% for plans in plani %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>{{ plans.lietotajs.first_name }} {{ plans.lietotajs.last_name }}</strong> —
                                {{ plans.menesis }}/{{ plans.gads }}
                            </span>
                            <div class="btn-group btn-group-sm" role="group">
                                {% if perms.baze.change_plans %}
                                <a href="{% url 'edit-plans' plans.id %}" class="btn btn-outline-secondary">Rediģēt</a>
                                {% endif %}
                                {% if perms.baze.delete_plans %}
                                <a href="javascript:void(0);"
                                    class="btn btn-outline-danger"
                                    data-id="{{ plans.id }}"
                                    data-info="plānu: {{ plans.lietotajs.first_name }} - {{ plans.menesis }}/{{ plans.gads }}"
                                    data-url="{% url 'delete-plans' plans.id %}"
                                    onclick="openDeleteModal(this)">
                                    Dzēst
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Nav pievienotu plānu šim mēnesim.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            {% for chart in grafiki %}
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    {{ chart|safe }}
                </div>
            </div>
            {% empty %}
            <div class="alert alert-info" role="alert">
                Nav pieejamu plānu vai darījumu datu.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="deleteModalLabel">Dzēst plānu</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Atcelt</button>
                <form id="deleteForm" method="POST" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Dzēst</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}